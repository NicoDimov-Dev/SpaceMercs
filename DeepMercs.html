<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceMercs INC</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --text-primary: #f020f0;
            --text-secondary: #909090;
            --accent-primary: #20d0d0;
            --border-color: #f020f0;
            --danger-color: #ff0000;
            --font-family: 'VT323', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 20px;
            text-transform: uppercase;
            text-shadow: 0 0 5px var(--text-primary);
        }
        .game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            border: 2px solid var(--border-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .game-wrapper::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 100px 20px rgba(0,0,0,0.75);
            pointer-events: none;
            z-index: 999;
        }
        .game-wrapper::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3) 1px, transparent 1px, transparent 3px);
            pointer-events: none;
            z-index: 1000;
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker {
            0%   { opacity: 0.95; }
            50%  { opacity: 1; }
            100% { opacity: 0.95; }
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .header-title { text-align: center; flex-grow: 1; }
        .header-title h1 { font-size: 36px; font-weight: 400; margin: 0; line-height: 1; }
        .header-title p { font-size: 18px; color: var(--text-secondary); margin: 0; }

        header nav { display: flex; gap: 20px; }
        .nav-button { background: none; border: none; color: var(--text-secondary); font-family: var(--font-family); font-size: 24px; cursor: pointer; text-transform: uppercase; }
        .nav-button:hover, .nav-button.active { color: var(--text-primary); text-shadow: 0 0 8px var(--text-primary); }
        .nav-hint { color: var(--text-secondary); }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .persistent-resource-bar { display: flex; justify-content: center; gap: 30px; padding: 5px 0; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; flex-shrink: 0; }
        .resource-item { font-size: 18px; transition: color 0.3s; }
        .resource-item span { color: var(--accent-primary); text-shadow: 0 0 5px var(--accent-primary); }
        @keyframes red-glow { 0%, 100% { color: var(--text-primary); text-shadow: 0 0 5px var(--text-primary); } 50% { color: var(--danger-color); text-shadow: 0 0 8px var(--danger-color); } }
        .resource-glow { animation: red-glow 1s ease-in-out; }
        .page-container { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .page-header { margin-bottom: 20px; }
        .page-header h1 { font-size: 32px; font-weight: 400; }
        .page-header p { color: var(--text-secondary); font-size: 18px; }
        .game-section { display: none; }
        .game-section.active { display: block; }
        .card { border: 2px solid var(--border-color); padding: 20px; margin-bottom: 20px; background: rgba(10, 0, 10, 0.2); }
        h2 { font-size: 24px; font-weight: 400; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; margin-bottom: 15px; }
        .table-container { border: 2px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 2px solid var(--border-color); }
        th { color: var(--text-secondary); font-size: 18px; }
        tr:last-child td { border-bottom: none; }
        .status-tag { padding: 2px 6px; }
        .status-tag.available { background-color: var(--accent-primary); color: var(--bg-primary); text-shadow: none; }
        .status-tag.mission { background-color: var(--text-primary); color: var(--bg-primary); text-shadow: none; }
        .progress-bar { width: 100%; height: 10px; border: 2px solid var(--accent-primary); }
        .progress-bar-fill { height: 100%; background-color: var(--accent-primary); }
        button { background: none; color: var(--text-primary); border: 2px solid var(--text-primary); padding: 8px 15px; font-family: var(--font-family); font-size: 18px; cursor: pointer; text-transform: uppercase; text-shadow: 0 0 5px var(--text-primary); }
        button:hover { background-color: var(--text-primary); color: var(--bg-primary); text-shadow: none; }
        button:disabled { border-color: var(--text-secondary); color: var(--text-secondary); cursor: not-allowed; text-shadow: none; }
        button:disabled:hover { background: none; }
        .crafting-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .recipe-card, .item-card { border: 2px solid var(--border-color); }
        .recipe-card img, .item-card img { width: 100%; height: 140px; object-fit: cover; background-color: #111; border-bottom: 2px solid var(--border-color); }
        .recipe-card-body, .item-card-body { padding: 15px; }
        .recipe-card-body h3, .item-card-body h3 { font-size: 22px; }
        .recipe-card-body p, .item-card-body p { font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; }
        #map-grid { display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(8, 1fr); gap: 2px; width: 100%; height: 500px; border: 2px solid var(--border-color); background-color: #050505; }
        .map-tile { background-color: var(--bg-primary); cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--text-secondary); position: relative; }
        .map-tile:hover { background-color: #220022; }
        .map-tile.unlocked { color: var(--text-primary); }
        .map-tile .progress-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg); width: 80%; height: 80%; pointer-events: none; }
        .map-tile .progress-ring__circle { transition: stroke-dashoffset 0.35s; stroke: var(--text-primary); stroke-width: 4; fill: transparent; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-primary); border: 2px solid var(--border-color); margin: 10% auto; padding: 25px; width: 90%; max-width: 600px; }
        .close-button { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: var(--text-primary); }
        #game-over-overlay { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); justify-content: center; align-items: center; text-align: center; }
        #game-over-overlay h1 { font-size: 64px; }
        #game-over-overlay p { font-size: 32px; }
        .equipment-slot { padding: 10px; border: 2px solid var(--border-color); margin-bottom: 10px; }
        .equipment-slot span { display: block; margin-bottom: 5px; }
        .action-tooltip { position: absolute; transform: translateY(-110%); background-color: var(--danger-color); color: white; padding: 8px 12px; font-size: 16px; font-weight: 400; z-index: 2100; white-space: nowrap; border: 2px solid white; text-shadow: none; }
        footer {
            border-top: 2px solid var(--border-color);
            padding: 5px 15px;
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <div id="game-over-overlay">
        <div><h1>CONNECTION TERMINATED</h1><p>COMMANDER MIA</p></div>
    </div>

    <div class="game-wrapper">
        <header>
            <div class="header-title">
                <h1>SpaceMercs INC</h1>
                <p>by NicoDimov</p>
            </div>
        </header>

        <nav id="main-nav" style="justify-content: center; flex-direction: row; gap: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
            <span class="nav-hint">[LB]</span>
            <button class="nav-button active" data-tab="base">Dashboard</button>
            <button class="nav-button" data-tab="commander">Commander</button>
            <button class="nav-button" data-tab="mercs">Operatives</button>
            <button class="nav-button" data-tab="recruitment">Recruit</button>
            <button class="nav-button" data-tab="inventory">Inventory</button>
            <button class="nav-button" data-tab="map">Starmap</button>
            <button class="nav-button" data-tab="crafting">Fabricator</button>
            <span class="nav-hint">[RB]</span>
        </nav>

        <main id="main-content" class="main-content">
            <div id="persistent-resource-bar" class="persistent-resource-bar"></div>
            <div class="page-container">
                <section id="base-section" class="game-section active"><div class="page-header"><h1>Command Dashboard</h1><p>System overview of your orbital platform.</p></div><h2>Fabrication Queue</h2><div class="table-container" id="production-queue-table"></div><h2 style="margin-top: 30px;">Active Missions</h2><div class="table-container" id="active-missions-table"></div></section>
                <section id="commander-section" class="game-section"></section>
                <section id="mercs-section" class="game-section"><div class="page-header"><h1>Operative Roster</h1><p>Manage your elite crew.</p></div><div class="filter-buttons" id="merc-filter-buttons"><button class="active" data-filter="all">All</button><button data-filter="available">Available</button><button data-filter="mission">On Mission</button></div><div class="table-container" id="merc-list-table"></div></section>
                <section id="recruitment-section" class="game-section"><div class="page-header"><h1>Recruitment Center</h1><p>Hire new operatives from across the galaxy.</p></div><div class="card"><h2>Hire Operative</h2><p>Find new talent to join your cause. Each operative brings a unique set of skills.</p><button id="recruit-merc-btn">Hire Operative // 1500 CREDITS</button></div></section>
                <section id="inventory-section" class="game-section"><div class="page-header"><h1>Inventory</h1><p>All fabricated equipment and consumables are stored here.</p></div><div id="inventory-container" class="inventory-grid"></div></section>
                <section id="map-section" class="game-section"><div class="page-header"><h1>Starmap</h1><p>Chart the void. Click a sector to view details and deploy a team.</p></div><div id="map-grid"></div></section>
                <section id="crafting-section" class="game-section"><div class="page-header"><h1>Fabricator</h1><p>Use materials to fabricate equipment and research new technologies.</p></div><div id="crafting-recipes-container"></div></section>
            </div>
        </main>
        
        <footer>
            <p>Copyright 2984, NicoDimov Corp. All rights reserved. Any unauthorized duplication, distribution, or lobotomization of our intellectual property is strictly prohibited and punishable by immediate termination of your neural license.</p>
        </footer>
    </div>

    <div id="main-modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2 id="modal-title"></h2><div id="modal-body"></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        let gameLoopInterval = null;

        const gameState = {
            resources: { food: 500, fuel: 250, materials: 1000, credits: 2500, energy: 300, scoutDrones: 1 },
            inventory: [
                { id: 1, name: 'Med-Syringe', type: 'utility', power: 5, img: 'https://placehold.co/400x240/110011/f020f0?text=Med-Syringe' },
                { id: 2, name: 'Pulse Rifle', type: 'weapon', power: 30, img: 'https://placehold.co/400x240/110011/f020f0?text=Pulse+Rifle' }
            ],
            commander: { id: 0, name: 'Commander', class: 'Strategist', level: 1, isCommander: true, equipment: { weapon: null, armor: null, utility: null } },
            mercenaries: [],
            missions: { active: [] },
            crafting: {
                queue: [],
                recipes: [
                    { id: 'medkit', name: 'Med-Syringe', cost: { materials: 25 }, time: 10, category: 'Consumables', type: 'utility', power: 5, isUnlocked: true, img: 'https://placehold.co/400x240/110011/f020f0?text=Med-Syringe' },
                    { id: 'armor1', name: 'Exo-Armor Plating', cost: { materials: 150 }, time: 60, category: 'Armor', type: 'armor', power: 20, isUnlocked: true, img: 'https://placehold.co/400x240/110011/f020f0?text=Exo-Armor' },
                    { id: 'rifle1', name: 'Pulse Rifle', cost: { materials: 200, energy: 25 }, time: 90, category: 'Weapons', type: 'weapon', power: 30, isUnlocked: true, img: 'https://placehold.co/400x240/110011/f020f0?text=Pulse+Rifle' },
                    { id: 'scout_drone', name: 'Scout Drone', cost: { materials: 300, energy: 100 }, time: 120, category: 'Tools', type: 'drone', isUnlocked: true, img: 'https://placehold.co/400x240/110011/f020f0?text=Scout+Drone' },
                    { id: 'research_armor2', name: 'Advanced Plating R&D', cost: { materials: 500, credits: 1000 }, time: 300, category: 'R&D', type: 'research', unlocks: 'armor2', isUnlocked: true, img: 'https://placehold.co/400x240/110011/f020f0?text=R&D:+Armor' },
                    { id: 'armor2', name: 'Aegis Armor', cost: { materials: 400, energy: 50 }, time: 180, category: 'Armor', type: 'armor', power: 50, isUnlocked: false, img: 'https://placehold.co/400x240/110011/f020f0?text=Aegis+Armor' },
                ]
            },
            map: { locations: { '2,2': { name: 'Derelict Freighter', status: 'idle', mission: { id: 'salvage_freighter', name: 'Salvage Freighter', difficulty: 20, cost: { fuel: 20 }, duration: 60, rewards: { materials: 200, credits: 500 } } }, '5,4': { name: 'Asteroid Cluster', status: 'idle', mission: { id: 'mine_asteroids', name: 'Mine Asteroids', difficulty: 40, cost: { fuel: 30 }, duration: 120, rewards: { materials: 400, energy: 50 } } } } },
            nextMercId: 1,
            nextItemId: 3,
            mercNames: ["Jax", "Vex", "Kira", "Zane", "Nyx", "Roric"],
            mercClasses: ["Marksman", "Vanguard", "Medic", "Technician", "Ghost"],
        };
        
        const elements = {
            mainContent: document.getElementById('main-content'),
            navButtons: document.querySelectorAll('.nav-button'),
            gameSections: document.querySelectorAll('.game-section'),
            resourceBar: document.getElementById('persistent-resource-bar'),
            productionQueueTable: document.getElementById('production-queue-table'),
            activeMissionsTable: document.getElementById('active-missions-table'),
            commanderSection: document.getElementById('commander-section'),
            mercFilterButtons: document.getElementById('merc-filter-buttons'),
            mercListTable: document.getElementById('merc-list-table'),
            inventoryContainer: document.getElementById('inventory-container'),
            craftingRecipesContainer: document.getElementById('crafting-recipes-container'),
            mapGrid: document.getElementById('map-grid'),
            modal: document.getElementById('main-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            closeButton: document.querySelector('.close-button'),
            gameOverOverlay: document.getElementById('game-over-overlay'),
        };

        const getOperativeById = (id) => [gameState.commander, ...gameState.mercenaries].find(op => op.id === id);
        const getMercPower = (merc) => { let power = merc.level * 10; for (const slot in merc.equipment) { if (merc.equipment[slot]) { power += merc.equipment[slot].power; } } return power; };
        const getSuccessChance = (power, difficulty) => Math.round(Math.min(95, 50 + (power - difficulty) * 1.5));
        const hasEnoughResources = (cost) => Object.entries(cost).every(([r, a]) => gameState.resources[r] >= a);
        const addResources = (rewards) => { Object.entries(rewards).forEach(([r, a]) => { if(gameState.resources[r] !== undefined) gameState.resources[r] += a; }); };
        
        function handleResourceShortage(cost, element) {
            const missing = Object.entries(cost).filter(([res, amount]) => gameState.resources[res] < amount);
            missing.forEach(([res]) => {
                const resElement = document.getElementById(`resource-${res}`);
                if (resElement) {
                    resElement.classList.add('resource-glow');
                    setTimeout(() => resElement.classList.remove('resource-glow'), 1000);
                }
            });
            const tooltip = document.createElement('div');
            tooltip.className = 'action-tooltip';
            tooltip.textContent = 'Missing: ' + missing.map(([res, amount]) => `${amount - gameState.resources[res]} ${res}`).join(', ');
            document.body.appendChild(tooltip);
            const btnRect = element.getBoundingClientRect();
            tooltip.style.left = `${btnRect.left + window.scrollX}px`;
            tooltip.style.top = `${btnRect.top + window.scrollY}px`;
            setTimeout(() => tooltip.remove(), 2000);
        }

        const spendResources = (cost, element) => { 
            if (hasEnoughResources(cost)) {
                Object.entries(cost).forEach(([r, a]) => gameState.resources[r] -= a);
                return true;
            }
            handleResourceShortage(cost, element);
            return false;
        };

        function renderAll() { renderResources(); renderProductionQueue(); renderCommander(); renderMercs(); renderCrafting(); renderActiveMissions(); renderMap(); renderInventory(); }
        function renderResources() { elements.resourceBar.innerHTML = Object.entries(gameState.resources).map(([name, value]) => `<div class="resource-item" id="resource-${name}">${name.replace(/([A-Z])/g, ' $1')}: <span>${value.toLocaleString()}</span></div>`).join(''); }
        function renderProductionQueue() {
            let content = '<table><tbody><tr><td style="text-align: center; color: var(--text-secondary);">No active fabrication jobs.</td></tr></tbody></table>';
            if (gameState.crafting.queue.length > 0) { content = `<table><thead><tr><th>Item</th><th>Time Left</th><th>Progress</th></tr></thead><tbody>${gameState.crafting.queue.map(item => `<tr><td>${item.name}</td><td>${item.timeLeft}s</td><td><div class="progress-bar"><div class="progress-bar-fill" style="width: ${((item.time - item.timeLeft) / item.time) * 100}%"></div></div></td></tr>`).join('')}</tbody></table>`; }
            elements.productionQueueTable.innerHTML = content;
        }
        function renderCommander() {
            const commander = gameState.commander;
            elements.commanderSection.innerHTML = `<div class="page-header"><h1>Commander Profile</h1></div><div class="card"><h2>${commander.name}</h2><p>Class: ${commander.class} // Level: ${commander.level} // Power: ${getMercPower(commander)}</p></div><div class="card"><h2>Equipment</h2><div id="commander-equipment"></div></div>`;
            renderEquipment(commander, document.getElementById('commander-equipment'));
        }
        function renderMercs(filter = 'all') {
            const filtered = gameState.mercenaries.filter(merc => {
                const isOnMission = gameState.missions.active.some(m => m.mercId === merc.id);
                if (filter === 'available') return !isOnMission; if (filter === 'mission') return isOnMission; return true;
            });
            let content = '<table><tbody><tr><td style="text-align: center; color: var(--text-secondary);">No operatives match filter.</td></tr></tbody></table>';
            if (filtered.length > 0) {
                content = `<table><thead><tr><th>Name</th><th>Class</th><th>Level</th><th>Power</th><th>Status</th><th></th></tr></thead><tbody>
                    ${filtered.map(merc => `<tr><td>${merc.name}</td><td>${merc.class}</td><td>${merc.level}</td><td>${getMercPower(merc)}</td>
                    <td><span class="status-tag ${gameState.missions.active.some(m=>m.mercId===merc.id) ? 'mission' : 'available'}">${gameState.missions.active.some(m=>m.mercId===merc.id) ? 'On Mission' : 'Available'}</span></td>
                    <td><button class="view-profile-btn" data-merc-id="${merc.id}">View Profile</button></td></tr>`).join('')}</tbody></table>`;
            }
            elements.mercListTable.innerHTML = content;
        }
        function renderCrafting() {
            const categories = [...new Set(gameState.crafting.recipes.map(r => r.category))];
            elements.craftingRecipesContainer.innerHTML = categories.map(cat => `<div><h2>${cat}</h2><div class="crafting-grid">${gameState.crafting.recipes.filter(r => r.category === cat && r.isUnlocked).map(recipe => {
                const isInQueue = gameState.crafting.queue.some(item => item.id === recipe.id);
                return `<div class="recipe-card"><img src="${recipe.img}" alt="${recipe.name}"><div class="recipe-card-body"><h3>${recipe.name}</h3><p>${Object.entries(recipe.cost).map(([r,c])=>`${c} ${r}`).join(', ')} // ${recipe.time}s</p><button class="craft-btn" data-recipe-id="${recipe.id}" ${isInQueue ? 'disabled' : ''}>${isInQueue ? 'In Queue' : (recipe.type === 'research' ? 'Research' : 'Fabricate')}</button></div></div>`
            }).join('')}</div></div>`).join('');
        }
        function renderInventory() {
            if (gameState.inventory.length === 0) {
                elements.inventoryContainer.innerHTML = `<p style="color: var(--text-secondary);">Your inventory is empty. Fabricate items to see them here.</p>`;
                return;
            }
            elements.inventoryContainer.innerHTML = gameState.inventory.map(item => `<div class="item-card"><img src="${item.img}" alt="${item.name}"><div class="item-card-body"><h3>${item.name}</h3><p>Type: ${item.type} // Power: ${item.power}</p></div></div>`).join('');
        }
        function renderActiveMissions() {
            let content = '<table><tbody><tr><td style="text-align: center; color: var(--text-secondary);">No missions in progress.</td></tr></tbody></table>';
            if (gameState.missions.active.length > 0) { content = `<table><thead><tr><th>Mission</th><th>Operative</th><th>Time Left</th><th>Progress</th></tr></thead><tbody>${gameState.missions.active.map(mission => `<tr><td>${mission.name}</td><td>${mission.mercId !== null ? getOperativeById(mission.mercId).name : 'Drone'}</td><td>${mission.timeLeft}s</td><td><div class="progress-bar"><div class="progress-bar-fill" style="width: ${((mission.duration - mission.timeLeft) / mission.duration) * 100}%"></div></div></td></tr>`).join('')}</tbody></table>`; }
            elements.activeMissionsTable.innerHTML = content;
        }
        function renderMap() {
            elements.mapGrid.innerHTML = '';
            for (let r = 0; r < 8; r++) { for (let c = 0; c < 10; c++) {
                const coord = `${r},${c}`;
                const tile = document.createElement('div');
                tile.className = 'map-tile';
                tile.dataset.coord = coord;
                const location = gameState.map.locations[coord];
                const activeMission = gameState.missions.active.find(m => m.coord === coord);
                let content = '·';
                if (location) { tile.classList.add('unlocked'); content = '★'; }
                if (activeMission) {
                    const progress = (activeMission.duration - activeMission.timeLeft) / activeMission.duration;
                    const radius = 18;
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - progress * circumference;
                    content += `<svg class="progress-ring" viewBox="0 0 40 40"><circle class="progress-ring__circle" r="${radius}" cx="20" cy="20" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle></svg>`;
                }
                tile.innerHTML = content;
                elements.mapGrid.appendChild(tile);
            } }
        }
        function renderEquipment(merc, container) {
            container.innerHTML = Object.keys(merc.equipment).map(slot => `<div class="equipment-slot"><span><strong>${slot.toUpperCase()}:</strong> ${merc.equipment[slot] ? `${merc.equipment[slot].name} (Pwr: ${merc.equipment[slot].power})` : 'Empty'}</span><button class="equip-btn" data-merc-id="${merc.id}" data-slot="${slot}">${merc.equipment[slot] ? 'Change' : 'Equip'}</button></div>`).join('');
        }
        
        function showLocationModal(coord) {
            const location = gameState.map.locations[coord];
            const activeMission = gameState.missions.active.find(m => m.coord === coord);
            elements.modalTitle.textContent = location ? location.name : `Uncharted Sector [${coord}]`;
            let body = '';
            if (activeMission) { body = `<p>A mission is already underway in this sector.</p><p>Time Remaining: ${activeMission.timeLeft}s</p>`; }
            else if (location) {
                const availableMercs = [gameState.commander, ...gameState.mercenaries].filter(m => !gameState.missions.active.some(mis => mis.mercId === m.id));
                let mercSelectorHTML = '<p>No available operatives.</p>';
                if (availableMercs.length > 0) {
                    mercSelectorHTML = `<label for="merc-select" style="display:block; margin-bottom:10px;">Assign Operative:</label><select id="merc-select" style="width: 100%; padding: 8px; margin-bottom: 15px; background: #000; color: #fff; border: 2px solid #fff; font-family: var(--font-family); font-size: 18px;">${availableMercs.map(m => `<option value="${m.id}">${m.name} (Pwr: ${getMercPower(m)})</option>`).join('')}</select><p id="success-chance-p"></p><button id="deploy-btn" data-coord="${coord}">Deploy</button>`;
                }
                body = `<p><strong>Mission:</strong> ${location.mission.name}</p><p><strong>Difficulty:</strong> ${location.mission.difficulty}</p><p><strong>Cost:</strong> ${Object.entries(location.mission.cost).map(([r,v])=>`${v} ${r}`).join(', ')}</p><p><strong>Rewards:</strong> ${Object.entries(location.mission.rewards).map(([r,v])=>`${v} ${r}`).join(', ')}</p><hr style="border-color: var(--border-color); margin: 15px 0;">${mercSelectorHTML}`;
            } else {
                body = `<p>This sector is a mystery.</p>`;
                if (gameState.resources.scoutDrones > 0) { body += `<p>You have ${gameState.resources.scoutDrones} Scout Drone(s) available.</p><button id="scout-btn" data-coord="${coord}">Deploy Scout Drone // 10 Fuel, 30s</button>`; }
                else { body += `<p>Fabricate more Scout Drones to explore uncharted space.</p>`; }
            }
            elements.modalBody.innerHTML = body;
            elements.modal.style.display = 'block';

            const mercSelect = document.getElementById('merc-select');
            if (mercSelect) {
                const updateSuccessChance = () => {
                    const location = gameState.map.locations[coord];
                    const selectedMerc = getOperativeById(parseInt(mercSelect.value));
                    if (selectedMerc && location) {
                        const chance = getSuccessChance(getMercPower(selectedMerc), location.mission.difficulty);
                        document.getElementById('success-chance-p').textContent = `Success Chance: ${chance}%`;
                    }
                };
                updateSuccessChance();
                mercSelect.onchange = updateSuccessChance;
            }
        }
        function showMercProfileModal(mercId) {
            const merc = getOperativeById(mercId);
            if (!merc) return;
            elements.modalTitle.textContent = `Profile: ${merc.name}`;
            elements.modalBody.innerHTML = `<div class="card"><h2>${merc.name}</h2><p>Class: ${merc.class} // Level: ${merc.level} // Power: ${getMercPower(merc)}</p></div><div class="card"><h2>Equipment</h2><div id="merc-equipment-container"></div></div>`;
            renderEquipment(merc, document.getElementById('merc-equipment-container'));
            elements.modal.style.display = 'block';
        }
        function showEquipmentModal(mercId, slot) {
            const merc = getOperativeById(mercId);
            const compatibleItems = gameState.inventory.filter(item => item.type === slot);
            elements.modalTitle.textContent = `Equip ${slot.toUpperCase()}`;
            let body = '<p>No compatible items in inventory.</p>';
            if (compatibleItems.length > 0) { body = compatibleItems.map(item => `<div class="equipment-slot"><span>${item.name} (Pwr: ${item.power})</span><button class="equip-item-btn" data-item-id="${item.id}" data-merc-id="${mercId}" data-slot="${slot}">Equip</button></div>`).join(''); }
            body += `<hr style="border-color: var(--border-color); margin: 15px 0;"><button class="unequip-btn" data-merc-id="${mercId}" data-slot="${slot}">Unequip Slot</button>`;
            elements.modalBody.innerHTML = body;
            elements.modal.style.display = 'block';
        }
        function closeModal() { elements.modal.style.display = 'none'; }

        function sendOnMission(mercId, missionTemplate, coord, element) { if (spendResources(missionTemplate.cost, element)) { gameState.missions.active.push({ ...missionTemplate, mercId, timeLeft: missionTemplate.duration, coord }); closeModal(); renderAll(); } }
        function scoutSector(coord, element) { if (spendResources({ fuel: 10 }, element)) { gameState.resources.scoutDrones--; gameState.missions.active.push({ id: 'scout_mission', name: `Scouting ${coord}`, type: 'scout', timeLeft: 30, duration: 30, coord, mercId: null }); closeModal(); renderAll(); } }
        function recruitMerc(element) { if (spendResources({ credits: 1500 }, element)) { gameState.mercenaries.push({ id: gameState.nextMercId++, name: gameState.mercNames[Math.floor(Math.random() * gameState.mercNames.length)], class: gameState.mercClasses[Math.floor(Math.random() * gameState.mercClasses.length)], level: 1, equipment: { weapon: null, armor: null, utility: null } }); renderAll(); } }
        function craftItem(recipeId, element) {
            const recipe = gameState.crafting.recipes.find(r => r.id === recipeId);
            if (recipe && !gameState.crafting.queue.some(item => item.id === recipeId) && spendResources(recipe.cost, element)) {
                if (recipe.type === 'drone') { gameState.resources.scoutDrones++; renderAll(); } 
                else { gameState.crafting.queue.push({ ...recipe, timeLeft: recipe.time }); }
                renderCrafting();
                renderProductionQueue();
            }
        }
        function equipItem(mercId, slot, itemId) {
            const merc = getOperativeById(mercId);
            const itemIndex = gameState.inventory.findIndex(i => i.id === itemId);
            if (!merc || itemIndex === -1) return;
            if (merc.equipment[slot]) { gameState.inventory.push(merc.equipment[slot]); }
            merc.equipment[slot] = gameState.inventory[itemIndex];
            gameState.inventory.splice(itemIndex, 1);
            closeModal();
            renderAll();
        }
        function unequipItem(mercId, slot) {
            const merc = getOperativeById(mercId);
            if (!merc || !merc.equipment[slot]) return;
            gameState.inventory.push(merc.equipment[slot]);
            merc.equipment[slot] = null;
            closeModal();
            renderAll();
        }
        function gameOver() { clearInterval(gameLoopInterval); elements.gameOverOverlay.style.display = 'flex'; }

        function gameTick() {
            let needsRender = false;
            // Crafting & Research
            gameState.crafting.queue.forEach(item => item.timeLeft--);
            const finishedJobs = gameState.crafting.queue.filter(item => item.timeLeft <= 0);
            if (finishedJobs.length > 0) {
                finishedJobs.forEach(job => {
                    if (job.type === 'research') { const recipeToUnlock = gameState.crafting.recipes.find(r => r.id === job.unlocks); if(recipeToUnlock) recipeToUnlock.isUnlocked = true; }
                    else { gameState.inventory.push({ ...job, id: gameState.nextItemId++ }); }
                });
                gameState.crafting.queue = gameState.crafting.queue.filter(item => item.timeLeft > 0);
                needsRender = true;
            }
            // Missions
            gameState.missions.active.forEach(mission => mission.timeLeft--);
            const finishedMissions = gameState.missions.active.filter(m => m.timeLeft <= 0);
            if (finishedMissions.length > 0) {
                finishedMissions.forEach(mission => {
                    if (mission.type === 'scout') { if (Math.random() > 0.5) { gameState.map.locations[mission.coord] = { name: 'New Anomaly', status: 'idle', mission: { id: `anomaly_${mission.coord}`, name: `Investigate ${mission.coord}`, difficulty: 50, cost: { fuel: 20 }, duration: 60, rewards: { materials: 300, credits: 1000 } } }; } }
                    else {
                        const merc = getOperativeById(mission.mercId);
                        if (Math.random() * 100 < getSuccessChance(getMercPower(merc), mission.difficulty)) { addResources(mission.rewards); merc.level++; }
                        else { if (merc.isCommander) { gameOver(); return; } }
                    }
                });
                gameState.missions.active = gameState.missions.active.filter(m => m.timeLeft > 0);
                needsRender = true;
            }
            if (needsRender) { renderAll(); } else { renderProductionQueue(); renderActiveMissions(); renderMap(); }
        }

        function init() {
            document.addEventListener('click', (e) => {
                const target = e.target;
                const mapTile = target.closest('.map-tile');

                if (mapTile) {
                    showLocationModal(mapTile.dataset.coord);
                } else if (target.matches('.view-profile-btn')) {
                    showMercProfileModal(parseInt(target.dataset.mercId));
                } else if (target.matches('.craft-btn')) {
                    craftItem(target.dataset.recipeId, target);
                } else if (target.matches('.equip-btn')) {
                    showEquipmentModal(parseInt(target.dataset.mercId), target.dataset.slot);
                } else if (target.matches('#recruit-merc-btn')) {
                    recruitMerc(target);
                } else if (target.matches('.equip-item-btn')) {
                    equipItem(parseInt(target.dataset.mercId), target.dataset.slot, parseInt(target.dataset.itemId));
                } else if (target.matches('.unequip-btn')) {
                    unequipItem(parseInt(target.dataset.mercId), target.dataset.slot);
                } else if (target.matches('#deploy-btn')) {
                    const mercSelect = document.getElementById('merc-select');
                    const location = gameState.map.locations[target.dataset.coord];
                    sendOnMission(parseInt(mercSelect.value), location.mission, target.dataset.coord, target);
                } else if (target.matches('#scout-btn')) {
                    scoutSector(target.dataset.coord, target);
                }
            });

            elements.navButtons.forEach(button => button.addEventListener('click', () => { if (button.disabled) return; elements.navButtons.forEach(btn => btn.classList.remove('active')); elements.gameSections.forEach(sec => sec.classList.remove('active')); button.classList.add('active'); document.getElementById(`${button.dataset.tab}-section`).classList.add('active'); }));
            elements.mercFilterButtons.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { elements.mercFilterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); renderMercs(e.target.dataset.filter); } });
            
            elements.modal.addEventListener('change', (e) => {
                if (e.target.matches('#merc-select')) {
                    const mercSelect = e.target;
                    const deployBtn = document.getElementById('deploy-btn');
                    if (deployBtn) {
                        const location = gameState.map.locations[deployBtn.dataset.coord];
                        const selectedMerc = getOperativeById(parseInt(mercSelect.value));
                        if (selectedMerc && location) {
                            const chance = getSuccessChance(getMercPower(selectedMerc), location.mission.difficulty);
                            document.getElementById('success-chance-p').textContent = `Success Chance: ${chance}%`;
                        }
                    }
                }
            });

            elements.closeButton.onclick = closeModal;
            window.onclick = (e) => { if (e.target == elements.modal) closeModal(); };
            
            renderAll();
            gameLoopInterval = setInterval(gameTick, 1000);
        }

        init();
    });
    </script>
</body>
</html>
